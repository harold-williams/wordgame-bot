from __future__ import annotations

from contextlib import contextmanager
from unittest.mock import patch

import pytest
from freezegun import freeze_time

from wordgame_bot.exceptions import (
    InvalidDay, InvalidFormatError,
    InvalidScore,
)
from wordgame_bot.quordle import (
    INCORRECT_GUESS_SCORE, QuordleAttempt,
    QuordleAttemptParser, QuordleGuessInfo,
)


@contextmanager
def remove_info_validation():
    with patch("wordgame_bot.quordle.QuordleGuessInfo.__post_init__"):
        yield


@freeze_time("2022, 2, 10")
@pytest.mark.parametrize(
    "attempt, expected_day, expected_score",
    [
        (
            (
                "Daily Quordle #17\n"
                "5ï¸âƒ£6ï¸âƒ£\n"
                "8ï¸âƒ£7ï¸âƒ£\n"
                "quordle.com\n"
                "ğŸŸ©ğŸŸ¨â¬œâ¬œğŸŸ¨ â¬œâ¬œğŸŸ¨â¬œğŸŸ¨\n"
                "â¬œğŸŸ¨ğŸŸ©â¬œâ¬œ â¬œğŸŸ¨â¬œâ¬œâ¬œ\n"
                "â¬œâ¬œâ¬œğŸŸ¨â¬œ â¬œâ¬œâ¬œâ¬œğŸŸ¨\n"
                "ğŸŸ¨â¬œâ¬œğŸŸ©â¬œ â¬œğŸŸ©ğŸŸ¨ğŸŸ©ğŸŸ¨\n"
                "ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ© â¬œâ¬œâ¬œğŸŸ©â¬œ\n"
                "â¬›â¬›â¬›â¬›â¬› ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©\n"
                "\n"
                "â¬œâ¬œâ¬œâ¬œğŸŸ¨ â¬œâ¬œâ¬œâ¬œâ¬œ\n"
                "â¬œğŸŸ©â¬œâ¬œğŸŸ© â¬œâ¬œâ¬œğŸŸ©â¬œ\n"
                "â¬œâ¬œâ¬œğŸŸ©â¬œ â¬œâ¬œâ¬œâ¬œâ¬œ\n"
                "â¬œâ¬œâ¬œğŸŸ¨â¬œ ğŸŸ©â¬œâ¬œâ¬œâ¬œ\n"
                "â¬œğŸŸ¨â¬œğŸŸ¨â¬œ â¬œâ¬œâ¬œâ¬œğŸŸ¨\n"
                "â¬œâ¬œâ¬œğŸŸ¨â¬œ â¬œâ¬œâ¬œâ¬œğŸŸ©\n"
                "â¬œâ¬œğŸŸ¨â¬œâ¬œ ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©\n"
                "ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ© â¬›â¬›â¬›â¬›â¬›"
            ),
            17,
            25,
        ),
        (
            (
                "Daily Quordle #17\n"
                "6ï¸âƒ£9ï¸âƒ£\n"
                "ğŸŸ¥8ï¸âƒ£\n"
                "quordle.com\n"
                "â¬œâ¬œâ¬œğŸŸ¨â¬œ â¬œâ¬œâ¬œâ¬œğŸŸ¨\n"
                "ğŸŸ¨ğŸŸ¨â¬œâ¬œâ¬œ â¬œğŸŸ¨â¬œğŸŸ¨â¬œ\n"
                "â¬œâ¬œğŸŸ¨â¬œâ¬œ â¬œğŸŸ©â¬œâ¬œâ¬œ\n"
                "â¬œâ¬œğŸŸ¨â¬œâ¬œ â¬œâ¬œâ¬œâ¬œğŸŸ©\n"
                "ğŸŸ¨ğŸŸ¨ğŸŸ©ğŸŸ©ğŸŸ¨ â¬œâ¬œâ¬œğŸŸ¨â¬œ\n"
                "ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ© â¬œâ¬œâ¬œğŸŸ¨â¬œ\n"
                "â¬›â¬›â¬›â¬›â¬› â¬œâ¬œâ¬œâ¬œğŸŸ¨\n"
                "â¬›â¬›â¬›â¬›â¬› â¬œğŸŸ¨â¬œğŸŸ¨â¬œ\n"
                "â¬›â¬›â¬›â¬›â¬› ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©\n"
                "\n"
                "â¬œâ¬œğŸŸ¨â¬œâ¬œ â¬œâ¬œâ¬œğŸŸ¨â¬œ\n"
                "â¬œğŸŸ¨â¬œâ¬œğŸŸ¨ â¬œğŸŸ¨ğŸŸ¨ğŸŸ¨â¬œ\n"
                "â¬œâ¬œâ¬œâ¬œâ¬œ â¬œâ¬œâ¬œâ¬œâ¬œ\n"
                "â¬œâ¬œâ¬œğŸŸ¨â¬œ â¬œğŸŸ©â¬œâ¬œâ¬œ\n"
                "â¬œâ¬œâ¬œğŸŸ¨â¬œ â¬œğŸŸ¨â¬œğŸŸ©â¬œ\n"
                "â¬œâ¬œâ¬œğŸŸ¨â¬œ ğŸŸ¨â¬œâ¬œğŸŸ©â¬œ\n"
                "â¬œâ¬œâ¬œâ¬œâ¬œ ğŸŸ©ğŸŸ¨â¬œğŸŸ¨â¬œ\n"
                "â¬œâ¬œâ¬œğŸŸ¨â¬œ ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©\n"
                "â¬œâ¬œğŸŸ©â¬œâ¬œ â¬›â¬›â¬›â¬›â¬›"
            ),
            17,
            16,
        ),
        (
            (
                "Daily Quordle #17\n"
                "4ï¸âƒ£ğŸŸ¥\n"
                "5ï¸âƒ£8ï¸âƒ£\n"
                "quordle.com\n"
                "ğŸŸ¨â¬œâ¬œğŸŸ©ğŸŸ© â¬œâ¬œâ¬œâ¬œğŸŸ¨\n"
                "â¬œğŸŸ¨â¬œâ¬œğŸŸ¨ ğŸŸ©ğŸŸ¨â¬œğŸŸ¨ğŸŸ©\n"
                "ğŸŸ©ğŸŸ©â¬œâ¬œâ¬œ â¬œğŸŸ¨â¬œâ¬œğŸŸ¨\n"
                "ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ© â¬œğŸŸ¨â¬œâ¬œğŸŸ¨\n"
                "â¬›â¬›â¬›â¬›â¬› â¬œâ¬œâ¬œâ¬œâ¬œ\n"
                "â¬›â¬›â¬›â¬›â¬› â¬œğŸŸ©ğŸŸ¨ğŸŸ©â¬œ\n"
                "â¬›â¬›â¬›â¬›â¬› â¬œğŸŸ¨ğŸŸ¨â¬œâ¬œ\n"
                "â¬›â¬›â¬›â¬›â¬› â¬œğŸŸ¨ğŸŸ¨â¬œâ¬œ\n"
                "â¬›â¬›â¬›â¬›â¬› ğŸŸ©ğŸŸ©â¬œğŸŸ©ğŸŸ©\n"
                "\n"
                "ğŸŸ¨â¬œâ¬œâ¬œâ¬œ â¬œâ¬œâ¬œâ¬œğŸŸ¨\n"
                "â¬œâ¬œâ¬œâ¬œâ¬œ â¬œğŸŸ©ğŸŸ¨ğŸŸ¨â¬œ\n"
                "ğŸŸ¨â¬œğŸŸ¨â¬œâ¬œ â¬œâ¬œâ¬œâ¬œâ¬œ\n"
                "ğŸŸ¨â¬œğŸŸ©â¬œâ¬œ â¬œâ¬œâ¬œâ¬œğŸŸ¨\n"
                "ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ© â¬œâ¬œâ¬œâ¬œâ¬œ\n"
                "â¬›â¬›â¬›â¬›â¬› â¬œğŸŸ¨â¬œğŸŸ¨ğŸŸ¨\n"
                "â¬›â¬›â¬›â¬›â¬› â¬œğŸŸ©â¬œğŸŸ©ğŸŸ©\n"
                "â¬›â¬›â¬›â¬›â¬› ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©"
            ),
            17,
            22,
        ),
    ],
)
def test_parse_valid_attempts(attempt: str, expected_score: int, expected_day: int):
    parser = QuordleAttemptParser(attempt)
    parsed_attempt = parser.parse()
    assert isinstance(parsed_attempt, QuordleAttempt)
    assert parsed_attempt.info.day == expected_day
    assert parsed_attempt.score == expected_score


@freeze_time("2022, 2, 10")
@pytest.mark.parametrize(
    "attempt, expected_error",
    [
        (
            (
                "Daily Quordle #24\n"
                "5ï¸âƒ£6ï¸âƒ£\n"
                "8ï¸âƒ£7ï¸âƒ£\n"
                "quordle.com\n"
                "ğŸŸ©ğŸŸ¨â¬œâ¬œğŸŸ¨ â¬œâ¬œğŸŸ¨â¬œğŸŸ¨\n"
                "â¬œğŸŸ¨ğŸŸ©â¬œâ¬œ â¬œğŸŸ¨â¬œâ¬œâ¬œ\n"
                "â¬œâ¬œâ¬œğŸŸ¨â¬œ â¬œâ¬œâ¬œâ¬œğŸŸ¨\n"
                "ğŸŸ¨â¬œâ¬œğŸŸ©â¬œ â¬œğŸŸ©ğŸŸ¨ğŸŸ©ğŸŸ¨\n"
                "ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ© â¬œâ¬œâ¬œğŸŸ©â¬œ\n"
                "â¬›â¬›â¬›â¬›â¬› ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©\n"
                "\n"
                "â¬œâ¬œâ¬œâ¬œğŸŸ¨ â¬œâ¬œâ¬œâ¬œâ¬œ\n"
                "â¬œğŸŸ©â¬œâ¬œğŸŸ© â¬œâ¬œâ¬œğŸŸ©â¬œ\n"
                "â¬œâ¬œâ¬œğŸŸ©â¬œ â¬œâ¬œâ¬œâ¬œâ¬œ\n"
                "â¬œâ¬œâ¬œğŸŸ¨â¬œ ğŸŸ©â¬œâ¬œâ¬œâ¬œ\n"
                "â¬œğŸŸ¨â¬œğŸŸ¨â¬œ â¬œâ¬œâ¬œâ¬œğŸŸ¨\n"
                "â¬œâ¬œâ¬œğŸŸ¨â¬œ â¬œâ¬œâ¬œâ¬œğŸŸ©\n"
                "â¬œâ¬œğŸŸ¨â¬œâ¬œ ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©\n"
                "ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ© â¬›â¬›â¬›â¬›â¬›"
            ),
            InvalidDay,
        ),
        (
            (
                "Daily Quordle #17\n"
                "8ï¸âƒ£8ï¸âƒ£\n"
                "8ï¸âƒ£8ï¸âƒ£\n"
                "quordle.com\n"
                "â¬œâ¬œâ¬œğŸŸ¨â¬œ â¬œâ¬œâ¬œâ¬œğŸŸ¨\n"
                "ğŸŸ¨ğŸŸ¨â¬œâ¬œâ¬œ â¬œğŸŸ¨â¬œğŸŸ¨â¬œ\n"
                "â¬œâ¬œğŸŸ¨â¬œâ¬œ â¬œğŸŸ©â¬œâ¬œâ¬œ\n"
                "â¬œâ¬œğŸŸ¨â¬œâ¬œ â¬œâ¬œâ¬œâ¬œğŸŸ©\n"
                "ğŸŸ¨ğŸŸ¨ğŸŸ©ğŸŸ©ğŸŸ¨ â¬œâ¬œâ¬œğŸŸ¨â¬œ\n"
                "ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ© â¬œâ¬œâ¬œğŸŸ¨â¬œ\n"
                "â¬›â¬›â¬›â¬›â¬› â¬œâ¬œâ¬œâ¬œğŸŸ¨\n"
                "â¬›â¬›â¬›â¬›â¬› â¬œğŸŸ¨â¬œğŸŸ¨â¬œ\n"
                "â¬›â¬›â¬›â¬›â¬› ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©\n"
                "\n"
                "â¬œâ¬œğŸŸ¨â¬œâ¬œ â¬œâ¬œâ¬œğŸŸ¨â¬œ\n"
                "â¬œğŸŸ¨â¬œâ¬œğŸŸ¨ â¬œğŸŸ¨ğŸŸ¨ğŸŸ¨â¬œ\n"
                "â¬œâ¬œâ¬œâ¬œâ¬œ â¬œâ¬œâ¬œâ¬œâ¬œ\n"
                "â¬œâ¬œâ¬œğŸŸ¨â¬œ â¬œğŸŸ©â¬œâ¬œâ¬œ\n"
                "â¬œâ¬œâ¬œğŸŸ¨â¬œ â¬œğŸŸ¨â¬œğŸŸ©â¬œ\n"
                "â¬œâ¬œâ¬œğŸŸ¨â¬œ ğŸŸ¨â¬œâ¬œğŸŸ©â¬œ\n"
                "â¬œâ¬œâ¬œâ¬œâ¬œ ğŸŸ©ğŸŸ¨â¬œğŸŸ¨â¬œ\n"
                "â¬œâ¬œâ¬œğŸŸ¨â¬œ ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©\n"
                "â¬œâ¬œğŸŸ©â¬œâ¬œ â¬›â¬›â¬›â¬›â¬›"
            ),
            InvalidScore,
        ),
        (
            (
                "Daily Quordle #17\n"
                "5ï¸âƒ£6ï¸âƒ£\n"
                "8ï¸âƒ£7ï¸âƒ£\n"
                "quordle.com\n"
                "â¬œâ¬œğŸŸ¨â¬œâ¬œ â¬œâ¬œâ¬œğŸŸ¨â¬œ\n"
                "â¬œğŸŸ¨â¬œâ¬œğŸŸ¨ â¬œğŸŸ¨ğŸŸ¨ğŸŸ¨â¬œ\n"
                "â¬œâ¬œâ¬œâ¬œâ¬œ â¬œâ¬œâ¬œâ¬œâ¬œ\n"
                "â¬œâ¬œâ¬œğŸŸ¨â¬œ â¬œğŸŸ©â¬œâ¬œâ¬œ\n"
                "â¬œâ¬œâ¬œğŸŸ¨â¬œ â¬œğŸŸ¨â¬œğŸŸ©â¬œ\n"
                "â¬œâ¬œâ¬œğŸŸ¨â¬œ ğŸŸ¨â¬œâ¬œğŸŸ©â¬œ\n"
                "â¬œâ¬œâ¬œâ¬œâ¬œ ğŸŸ©ğŸŸ¨â¬œğŸŸ¨â¬œ\n"
                "â¬œâ¬œâ¬œğŸŸ¨â¬œ ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©\n"
                "â¬œâ¬œğŸŸ©â¬œâ¬œ â¬›â¬›â¬›â¬›â¬›\n"
                "\n"
                "â¬œâ¬œğŸŸ¨â¬œâ¬œ â¬œâ¬œâ¬œğŸŸ¨â¬œ\n"
                "â¬œğŸŸ¨â¬œâ¬œğŸŸ¨ â¬œğŸŸ¨ğŸŸ¨ğŸŸ¨â¬œ\n"
                "â¬œâ¬œâ¬œâ¬œâ¬œ â¬œâ¬œâ¬œâ¬œâ¬œ\n"
                "â¬œâ¬œâ¬œğŸŸ¨â¬œ â¬œğŸŸ©â¬œâ¬œâ¬œ\n"
                "â¬œâ¬œâ¬œğŸŸ¨â¬œ â¬œğŸŸ¨â¬œğŸŸ©â¬œ\n"
                "â¬œâ¬œâ¬œğŸŸ¨â¬œ ğŸŸ¨â¬œâ¬œğŸŸ©â¬œ\n"
                "â¬œâ¬œâ¬œâ¬œâ¬œ ğŸŸ©ğŸŸ¨â¬œğŸŸ¨â¬œ\n"
                "â¬œâ¬œâ¬œğŸŸ¨â¬œ ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©\n"
                "â¬œâ¬œğŸŸ©â¬œâ¬œ â¬›â¬›â¬›â¬›â¬›"
            ),
            InvalidScore,
        ),
        (
            (
                "Daily Quordle #17\n"
                "4ï¸âƒ£4ï¸âƒ£4ï¸âƒ£4ï¸âƒ£\n"
                "ğŸŸ¨â¬œâ¬œğŸŸ©ğŸŸ© â¬œâ¬œâ¬œâ¬œğŸŸ¨\n"
                "â¬œğŸŸ¨â¬œâ¬œğŸŸ¨ ğŸŸ©ğŸŸ¨â¬œğŸŸ¨ğŸŸ©\n"
                "ğŸŸ©ğŸŸ©â¬œâ¬œâ¬œ â¬œğŸŸ¨â¬œâ¬œğŸŸ¨\n"
                "ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ© â¬œğŸŸ¨â¬œâ¬œğŸŸ¨\n"
                "â¬›â¬›â¬›â¬›â¬› â¬œâ¬œâ¬œâ¬œâ¬œ\n"
                "â¬›â¬›â¬›â¬›â¬› â¬œğŸŸ©ğŸŸ¨ğŸŸ©â¬œ\n"
                "â¬›â¬›â¬›â¬›â¬› â¬œğŸŸ¨ğŸŸ¨â¬œâ¬œ\n"
                "â¬›â¬›â¬›â¬›â¬› â¬œğŸŸ¨ğŸŸ¨â¬œâ¬œ\n"
                "â¬›â¬›â¬›â¬›â¬› ğŸŸ©ğŸŸ©â¬œğŸŸ©ğŸŸ©\n"
                "\n"
                "ğŸŸ¨â¬œâ¬œâ¬œâ¬œ â¬œâ¬œâ¬œâ¬œğŸŸ¨\n"
                "â¬œâ¬œâ¬œâ¬œâ¬œ â¬œğŸŸ©ğŸŸ¨ğŸŸ¨â¬œ\n"
                "ğŸŸ¨â¬œğŸŸ¨â¬œâ¬œ â¬œâ¬œâ¬œâ¬œâ¬œ\n"
                "ğŸŸ¨â¬œğŸŸ©â¬œâ¬œ â¬œâ¬œâ¬œâ¬œğŸŸ¨\n"
                "ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ© â¬œâ¬œâ¬œâ¬œâ¬œ\n"
                "â¬›â¬›â¬›â¬›â¬› â¬œğŸŸ¨â¬œğŸŸ¨ğŸŸ¨\n"
                "â¬›â¬›â¬›â¬›â¬› â¬œğŸŸ©â¬œğŸŸ©ğŸŸ©\n"
                "â¬›â¬›â¬›â¬›â¬› ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©"
            ),
            InvalidFormatError,
        ),
        (("Daily Quordle #17\n" "5ï¸âƒ£6ï¸âƒ£\n" "8ï¸âƒ£7ï¸âƒ£\n"), InvalidFormatError),
    ],
)
def test_parse_invalid_attempts(attempt: str, expected_error: Exception):
    parser = QuordleAttemptParser(attempt)
    with pytest.raises(expected_error):
        parser.parse()


@freeze_time("2022, 2, 10")
@pytest.mark.parametrize(
    "day, expected_day",
    [
        ("17", 17),
        ("16", 16),
        ("0", None),
        ("140", None),
        ("1st Feb", None),
    ],
)
def test_parse_day(day: str, expected_day: int | None):
    with remove_info_validation():
        guess_info = QuordleGuessInfo("", day=day)
        try:
            assert guess_info.parse_day() == expected_day
        except InvalidDay:
            assert expected_day is None


@pytest.mark.parametrize(
    "scores, expected_score",
    [
        (["8", "2", "4", "7"], 20),
        (["6", "3", "5", "7"], 20),
        (["ğŸŸ¥", "2", "4", "7"], 24),
        (["3", "2"], None),
        (["1", "1", "1", "1"], None),
        (["X", "X", "X", "X"], None),
    ],
)
def test_parse_score(scores: list[str], expected_score: int | None):
    with remove_info_validation():
        guess_info = QuordleGuessInfo("", scores=scores)
        try:
            assert guess_info.parse_score() == expected_score
        except InvalidScore:
            assert expected_score is None
